# 编译阶段

- 词法分析 Scanner
- 语法分析 Parser
- 字节码生成
- 作用域(变量)
- 词法作用域

---

# 执行阶段

## 执行上下文

1. 创建阶段

   - `确定 this 的值，也被称为 This Binding`
   - `LexicalEnvironment（词法环境） 组件被创建。`
   - `VariableEnvironment（变量环境） 组件被创建`。

   > 变量环境组件（VariableEnvironment） 是用来登记 var function 变量声明，词法环境组件
   > （LexicalEnvironment）是用来登记 let const class 等变量声明。

2. 执行阶段

> 执行栈 Execution Context Stack
> 每个函数都会有自己的执行上下文，多个执行上下文就会以栈(调用栈)的方式来管理。

# GC 垃圾回收

## 内存分配

> 栈是临时存储空间，主要存储局部变量和函数调用，内小且存储连续，操作起来简单方便，一般由系统自动分配，自动回收，所以文章内所说的`垃圾回收，都是基于堆内存`。

> 基本类型数据（Number, Boolean, String, Null, Undefined, Symbol, BigInt）保存在在栈内存中。`引用类型数据保存在堆内存中，引用数据类型的变量是一个指向堆内存中实际对象的引用，存在栈中。`

> 在 V8 中会把堆分为`新生代`和`老生代`两个区域，`新生代中存放的是生存时间短的对象，老生代中存放的生存时间久的对象。`  
> 新生代中用`Scavenge算法`来处理。所谓 Scavenge 算法，是把新生代空间对半划分为两个区域，一半是对象区域，一半是空闲区域。

## 新生代回收

> 新加入的对象都会存放到对象区域，当对象区域快被写满时，就需要执行一次垃圾清理操作。

> 1. 先标记需要回收的对象，然后把对象区激活对象复制到空闲区，并排序；
> 2. 完成复制后，对象区域与空闲区域进行角色翻转，也就是原来的对象区域变成空闲区域，原来的空闲区域变成了对象区域。

---

## 老生代回收

### Mark-Sweep

> `Mark-Sweep处理时分为两阶段，标记阶段和清理阶段`，看起来与 Scavenge 类似，不同的是，Scavenge 算法是复制活动对象，而由于在老生代中活动对象占大多数，所以 Mark-Sweep 在标记了活动对象和非活动对象之后，直接把非活动对象清除。

> 1. `标记阶段：对老生代进行第一次扫描，标记活动对象`
> 2. `清理阶段：对老生代进行第二次扫描，清除未被标记的对象，即清理非活动对象`

### Mark-Compact

> 由于 Mark-Sweep 完成之后，老生代的内存中产生了很多内存碎片，若不清理这些内存碎片，如果出现需要分配一个大对象的时候，这时所有的碎片空间都完全无法完成分配，就会提前触发垃圾回收，而这次回收其实不是必要的。

> 为了解决内存碎片问题，Mark-Compact 被提出，它是在是在 Mark-Sweep 的基础上演进而来的，相比 Mark-Sweep，`Mark-Compact添加了活动对象整理阶段，将所有的活动对象往一端移动，移动完成后，直接清理掉边界外的内存。`

---

## 增量标记

> `为了降低老生代的垃圾回收而造成的卡顿，V8 将标记过程分为一个个的子标记过程，同时让垃圾回收标记和 JavaScript 应用逻辑交替进行，直到标记阶段完成，`我们把这个算法称为增量标记（Incremental Marking）算法。

## 惰性清理

> `增量标记只是对活动对象和非活动对象进行标记，惰性清理用来真正的清理释放内存。`当增量标记完成后，假如当前的可用内存足以让我们快速的执行代码，其实我们是没必要立即清理内存的，可以将清理的过程延迟一下，让 JavaScript 逻辑代码先执行，也无需一次性清理完所有非活动对象内存，垃圾回收器会按需逐一进行清理，直到所有的页都清理完毕。

## 并发回收

> 并发式 GC 允许在在垃圾回收的同时不需要将主线程挂起，两者可以同时进行，只有在个别时候需要短暂停下来让垃圾回收器做一些特殊的操作。但是这种方式也要面对增量回收的问题，就是在垃圾回收过程中，由于 JavaScript 代码在执行，堆中的对象的引用关系随时可能会变化，所以也要进行写屏障操作。

## 并行回收

> 并行式 GC 允许主线程和辅助线程同时执行同样的 GC 工作，这样可以让辅助线程来分担主线程的 GC 工作，使得垃圾回收所耗费的时间等于总时间除以参与的线程数量（加上一些同步开销）。

---

## 参考:

- [javascript 执行过程](https://mp.weixin.qq.com/s/vO91ExXAUTqu3KKvqY382g)
